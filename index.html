<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Management IJP Hitachi PT. Dankos Farma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .status-rusak {
            background-color: #dc2626 !important;
            color: white !important;
        }
        
        .nav-button {
            transition: all 0.3s ease;
        }
        
        .nav-button.active {
            background-color: #1e40af;
            color: white;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-lg">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                            </div>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-white">Management IJP Hitachi PT. Dankos Farma</h1>
                            <p class="text-blue-100 text-sm">Dashboard Management Ink Jet Printer Hitachi V1.1</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-2 bg-white bg-opacity-20 rounded-full px-4 py-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-white font-medium">Online</span>
                        </div>
                        <div class="flex items-center space-x-2 text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm" id="currentTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showSection('dashboard')" class="nav-button active px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>Dashboard</span>
                    </button>
                    <button onclick="showSection('input-ijp')" class="nav-button px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Input IJP</span>
                    </button>
                    <button onclick="showSection('input-monitoring')" class="nav-button px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Input Monitoring</span>
                    </button>
                    <button onclick="showSection('input-repair')" class="nav-button px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Input Repair</span>
                    </button>
                    <button onclick="showSection('input-switching')" class="nav-button px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <span>Input Penukaran Unit IJP</span>
                    </button>
                    <button onclick="showSection('history')" class="nav-button px-4 py-4 text-sm font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>History</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Dashboard IJP Management</h2>
                    
                    <!-- Scoreboard Section -->
                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                        <div class="bg-white overflow-hidden shadow-xl rounded-lg border-l-4 border-blue-500 hover:shadow-2xl transition-shadow duration-300">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total IJP</dt>
                                            <dd class="text-3xl font-bold text-gray-900" id="totalIJP">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-xl rounded-lg border-l-4 border-green-500 hover:shadow-2xl transition-shadow duration-300">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">IJP Aktif</dt>
                                            <dd class="text-3xl font-bold text-green-600" id="totalAktif">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-xl rounded-lg border-l-4 border-yellow-500 hover:shadow-2xl transition-shadow duration-300">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Wajib Ganti Filter</dt>
                                            <dd class="text-3xl font-bold text-yellow-600" id="totalGantiFilter">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-xl rounded-lg border-l-4 border-red-500 hover:shadow-2xl transition-shadow duration-300">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">IJP Rusak</dt>
                                            <dd class="text-3xl font-bold text-red-600" id="totalRusak">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Statistik IJP per Departemen</h3>
                            </div>
                            <div class="p-6">
                                <canvas id="ijpChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Distribusi Tipe IJP per Departemen</h3>
                            </div>
                            <div class="p-6">
                                <canvas id="ijpTypeChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- IJP List by Department -->
                    <div class="space-y-6">
                        <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Daftar IJP per Departemen</h3>
                            </div>
                            <div class="p-6">
                                <div id="ijpList" class="space-y-6">
                                    <!-- IJP list will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input IJP Section -->
            <div id="input-ijp" class="section hidden">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Input IJP Baru</h2>
                    
                    <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                        <div class="px-6 py-6">
                            <form id="ijpForm" class="space-y-6">
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label for="departemen" class="block text-sm font-medium text-gray-700">Departemen</label>
                                        <select id="departemen" name="departemen" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Departemen</option>
                                            <option value="Line 01A">Line 01A</option>
                                            <option value="Line 01B">Line 01B</option>
                                            <option value="Line 02">Line 02</option>
                                            <option value="Line 03">Line 03</option>
                                            <option value="Line 04">Line 04</option>
                                            <option value="Line 05">Line 05</option>
                                            <option value="Line 07">Line 07</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="inisialPIC" class="block text-sm font-medium text-gray-700">Inisial PIC</label>
                                        <input type="text" id="inisialPIC" name="inisialPIC" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="tipeIJP" class="block text-sm font-medium text-gray-700">Tipe IJP</label>
                                        <select id="tipeIJP" name="tipeIJP" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Tipe IJP</option>
                                            <option value="PX">PX</option>
                                            <option value="PXR">PXR</option>
                                            <option value="RX1">RX1</option>
                                            <option value="RX2">RX2</option>
                                            <option value="UX Single">UX Single</option>
                                            <option value="UX Twin">UX Twin</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="lokasi" class="block text-sm font-medium text-gray-700">Lokasi</label>
                                        <input type="text" id="lokasi" name="lokasi" placeholder="Contoh: N 2510" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="mesinUtama" class="block text-sm font-medium text-gray-700">Mesin Utama</label>
                                        <input type="text" id="mesinUtama" name="mesinUtama" placeholder="Contoh: Kunglong 5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="serialNumber" class="block text-sm font-medium text-gray-700">Serial Number</label>
                                        <input type="text" id="serialNumber" name="serialNumber" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                        Simpan IJP
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Monitoring Section -->
            <div id="input-monitoring" class="section hidden">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Input Monitoring</h2>
                    
                    <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                        <div class="px-6 py-6">
                            <form id="monitoringForm" class="space-y-6">
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label for="monitoringPIC" class="block text-sm font-medium text-gray-700">Inisial PIC</label>
                                        <input type="text" id="monitoringPIC" name="monitoringPIC" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="monitoringSerial" class="block text-sm font-medium text-gray-700">Serial Number</label>
                                        <select id="monitoringSerial" name="monitoringSerial" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Serial Number</option>
                                        </select>
                                    </div>

                                    <div class="sm:col-span-2">
                                        <label for="additionalTime" class="block text-sm font-medium text-gray-700">Cummulative Op. Time (hours)</label>
                                        <input type="number" id="additionalTime" name="additionalTime" placeholder="Contoh: 100" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <p class="mt-1 text-sm text-gray-500">Masukkan nilai Cummulative Op. Time (Hours)</p>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                        Simpan Monitoring
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Repair Section -->
            <div id="input-repair" class="section hidden">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Input Repair</h2>
                    
                    <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                        <div class="px-6 py-6">
                            <form id="repairForm" class="space-y-6">
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label for="repairPIC" class="block text-sm font-medium text-gray-700">Inisial PIC</label>
                                        <input type="text" id="repairPIC" name="repairPIC" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="repairSerial" class="block text-sm font-medium text-gray-700">Serial Number</label>
                                        <select id="repairSerial" name="repairSerial" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Serial Number</option>
                                        </select>
                                    </div>

                                    <div class="sm:col-span-2">
                                        <label for="kerusakan" class="block text-sm font-medium text-gray-700">Kerusakan</label>
                                        <textarea id="kerusakan" name="kerusakan" rows="3" placeholder="Jelaskan kerusakan secara detail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                    </div>

                                    <div class="sm:col-span-2">
                                        <label for="action" class="block text-sm font-medium text-gray-700">Action</label>
                                        <textarea id="action" name="action" rows="3" placeholder="Jelaskan action secara detail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                    </div>

                                    <div class="sm:col-span-2">
                                        <div class="flex items-center">
                                            <input id="gantiFilterSet" name="gantiFilterSet" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <label for="gantiFilterSet" class="ml-2 block text-sm text-gray-900">
                                                Ganti Filter Set (Reset Cummulative Op. Time ke 0)
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                        Simpan Repair
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Switching Section -->
            <div id="input-switching" class="section hidden">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Input Penukaran Unit IJP</h2>
                    
                    <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                        <div class="px-6 py-6">
                            <form id="switchingForm" class="space-y-6">
                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div>
                                        <label for="switchingPIC" class="block text-sm font-medium text-gray-700">Inisial PIC</label>
                                        <input type="text" id="switchingPIC" name="switchingPIC" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>

                                    <div>
                                        <label for="serialDiganti" class="block text-sm font-medium text-gray-700">Serial Number IJP yang akan diganti</label>
                                        <select id="serialDiganti" name="serialDiganti" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Serial Number (Aktif)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="serialPengganti" class="block text-sm font-medium text-gray-700">Serial Number IJP Pengganti</label>
                                        <select id="serialPengganti" name="serialPengganti" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Pilih Serial Number Pengganti</option>
                                        </select>
                                    </div>

                                    <div class="sm:col-span-2">
                                        <label for="alasanPenggantian" class="block text-sm font-medium text-gray-700">Alasan Penggantian</label>
                                        <textarea id="alasanPenggantian" name="alasanPenggantian" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                        Simpan Penukaran
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section hidden">
                <div class="px-4 py-6 sm:px-0">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">History Aktivitas</h2>
                    
                    <div class="bg-white overflow-hidden shadow-xl rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900">Log Semua Aktivitas</h3>
                                <div class="flex space-x-2">
                                    <select id="historyFilter" class="text-sm border border-gray-300 rounded px-2 py-1">
                                        <option value="all">Semua Aktivitas</option>
                                        <option value="ijp">Input IJP</option>
                                        <option value="monitoring">Monitoring</option>
                                        <option value="repair">Repair</option>
                                        <option value="switching">Penukaran</option>
                                    </select>
                                    <button onclick="refreshHistory()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div id="historyList" class="space-y-4">
                                <!-- History will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://asvbztfrzczgrehmihqf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzdmJ6dGZyemN6Z3JlaG1paHFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MjQ2OTMsImV4cCI6MjA3NzIwMDY5M30.w10VaVZIX3CH8IPPsuEtNKqsHMaNWE9FPN3G9mVTsHE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Data arrays - will be populated from Supabase
        let ijpData = [];
        let monitoringData = [];
        let repairData = [];
        let switchingData = [];
        let chartInstance = null;
        let typeChartInstance = null;

        // Database functions
        async function loadAllData() {
            try {
                // Load IJP data
                const { data: ijps, error: ijpError } = await supabase
                    .from('ijp_master')
                    .select('*')
                    .order('serial_number');
                
                if (ijpError) throw ijpError;
                
                // Transform data to match our structure
                ijpData = ijps ? ijps.map(ijp => ({
                    id: ijp.id,
                    departemen: ijp.departemen,
                    inisialPIC: ijp.inisial_pic,
                    tipeIJP: ijp.tipe_ijp,
                    lokasi: ijp.lokasi,
                    mesinUtama: ijp.mesin_utama,
                    serialNumber: ijp.serial_number,
                    cummulativeTime: ijp.cummulative_time || 0,
                    status: ijp.status || 'AKTIF'
                })) : [];

                // Load monitoring data
                const { data: monitoring, error: monitoringError } = await supabase
                    .from('monitoring_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (monitoringError) throw monitoringError;
                monitoringData = monitoring || [];

                // Load repair data
                const { data: repairs, error: repairError } = await supabase
                    .from('repair_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (repairError) throw repairError;
                repairData = repairs || [];

                // Load switching data
                const { data: switching, error: switchingError } = await supabase
                    .from('switching_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (switchingError) throw switchingError;
                switchingData = switching || [];

                console.log('Data berhasil dimuat dari Supabase');
                
            } catch (error) {
                console.error('Error loading data:', error);
                // Use sample data if database fails
                ijpData = [
                    {
                        id: 1,
                        departemen: 'Line 01A',
                        inisialPIC: 'JD',
                        tipeIJP: 'PX',
                        lokasi: 'N 2510',
                        mesinUtama: 'Kunglong 5',
                        serialNumber: 'PX001A',
                        cummulativeTime: 9700,
                        status: 'AKTIF'
                    },
                    {
                        id: 2,
                        departemen: 'Line 02',
                        inisialPIC: 'SM',
                        tipeIJP: 'RX1',
                        lokasi: 'S 1205',
                        mesinUtama: 'Heidelberg 3',
                        serialNumber: 'RX001B',
                        cummulativeTime: 8500,
                        status: 'AKTIF'
                    }
                ];
            }
        }

        async function saveIJP(ijpData) {
            try {
                const { data, error } = await supabase
                    .from('ijp_master')
                    .insert([{
                        departemen: ijpData.departemen,
                        inisial_pic: ijpData.inisialPIC,
                        tipe_ijp: ijpData.tipeIJP,
                        lokasi: ijpData.lokasi,
                        mesin_utama: ijpData.mesinUtama,
                        serial_number: ijpData.serialNumber,
                        cummulative_time: ijpData.cummulativeTime || 0,
                        status: ijpData.status || 'AKTIF'
                    }])
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving IJP:', error);
                throw error;
            }
        }

        async function saveMonitoring(monitoringData) {
            try {
                // Get current cummulative time first
                const { data: currentIJP, error: fetchError } = await supabase
                    .from('ijp_master')
                    .select('cummulative_time')
                    .eq('serial_number', monitoringData.serialNumber)
                    .single();
                
                if (fetchError) throw fetchError;
                
                const currentTime = currentIJP.cummulative_time || 0;
                const newCummulativeTime = monitoringData.additionalTime;

                
                // Save to monitoring_log with existing column structure
                const { data, error } = await supabase
                    .from('monitoring_log')
                    .insert([{
                        inisial_pic: monitoringData.inisialPIC,
                        serial_number: monitoringData.serialNumber,
                        cummulative_time: newCummulativeTime
                    }])
                    .select();
                
                if (error) throw error;
                
                // Update IJP cummulative time (accumulate)
                await supabase
                    .from('ijp_master')
                    .update({ cummulative_time: newCummulativeTime })
                    .eq('serial_number', monitoringData.serialNumber);
                
                return data[0];
            } catch (error) {
                console.error('Error saving monitoring:', error);
                throw error;
            }
        }

        async function saveRepair(repairData) {
            try {
                const { data, error } = await supabase
                    .from('repair_log')
                    .insert([{
                        inisial_pic: repairData.inisialPIC,
                        serial_number: repairData.serialNumber,
                        kerusakan: repairData.kerusakan,
                        action: repairData.action,
                        ganti_filter_set: repairData.gantiFilterSet
                    }])
                    .select();
                
                if (error) throw error;
                
                // Reset cummulative time if filter changed
                if (repairData.gantiFilterSet) {
                    await supabase
                        .from('ijp_master')
                        .update({ cummulative_time: 0 })
                        .eq('serial_number', repairData.serialNumber);
                }
                
                return data[0];
            } catch (error) {
                console.error('Error saving repair:', error);
                throw error;
            }
        }

        async function saveSwitching(switchingData) {
            try {
                const { data, error } = await supabase
                    .from('switching_log')
                    .insert([{
                        inisial_pic: switchingData.inisialPIC,
                        serial_diganti: switchingData.serialDiganti,
                        serial_pengganti: switchingData.serialPengganti,
                        alasan_penggantian: switchingData.alasanPenggantian
                    }])
                    .select();
                
                if (error) throw error;
                
                // Update status if reason contains "rusak"
                if (switchingData.alasanPenggantian.toLowerCase().includes('rusak')) {
                    await supabase
                        .from('ijp_master')
                        .update({ status: 'RUSAK' })
                        .eq('serial_number', switchingData.serialDiganti);
                }
                
                return data[0];
            } catch (error) {
                console.error('Error saving switching:', error);
                throw error;
            }
        }

        // Auto uppercase functions
        function setupAutoUppercase() {
            const upperFields = ['inisialPIC', 'lokasi', 'serialNumber', 'monitoringPIC', 'repairPIC', 'switchingPIC'];
            
            upperFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
        }

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update dropdowns when switching sections
            if (sectionId === 'input-monitoring') {
                updateMonitoringDropdown();
            } else if (sectionId === 'input-repair') {
                updateRepairDropdown();
            } else if (sectionId === 'input-switching') {
                updateSwitchingDropdowns();
            } else if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'history') {
                updateHistory();
            }
        }

        // Update dropdowns
        function updateMonitoringDropdown() {
            const select = document.getElementById('monitoringSerial');
            select.innerHTML = '<option value="">Pilih Serial Number</option>';
            
            const sortedData = [...ijpData].sort((a, b) => a.serialNumber.localeCompare(b.serialNumber));
            
            sortedData.forEach(ijp => {
                const option = document.createElement('option');
                option.value = ijp.serialNumber;
                option.textContent = `${ijp.serialNumber} - ${ijp.mesinUtama} - ${ijp.departemen}`;
                select.appendChild(option);
            });
        }

        function updateRepairDropdown() {
            const select = document.getElementById('repairSerial');
            select.innerHTML = '<option value="">Pilih Serial Number</option>';
            
            const sortedData = [...ijpData].sort((a, b) => a.serialNumber.localeCompare(b.serialNumber));
            
            sortedData.forEach(ijp => {
                const option = document.createElement('option');
                option.value = ijp.serialNumber;
                option.textContent = `${ijp.serialNumber} - ${ijp.mesinUtama} - ${ijp.departemen}`;
                select.appendChild(option);
            });
        }

        function updateSwitchingDropdowns() {
            const activeSelect = document.getElementById('serialDiganti');
            const replacementSelect = document.getElementById('serialPengganti');
            
            activeSelect.innerHTML = '<option value="">Pilih Serial Number (Aktif)</option>';
            replacementSelect.innerHTML = '<option value="">Pilih Serial Number Pengganti</option>';
            
            const activeIJPs = ijpData.filter(ijp => ijp.status === 'AKTIF').sort((a, b) => a.serialNumber.localeCompare(b.serialNumber));
            const allIJPs = [...ijpData].sort((a, b) => a.serialNumber.localeCompare(b.serialNumber));
            
            activeIJPs.forEach(ijp => {
                const option = document.createElement('option');
                option.value = ijp.serialNumber;
                option.textContent = `${ijp.serialNumber} - ${ijp.mesinUtama} - ${ijp.departemen}`;
                activeSelect.appendChild(option);
            });
            
            allIJPs.forEach(ijp => {
                const option = document.createElement('option');
                option.value = ijp.serialNumber;
                option.textContent = `${ijp.serialNumber} - ${ijp.mesinUtama} - ${ijp.departemen}`;
                replacementSelect.appendChild(option);
            });
            
            // Update replacement dropdown when active selection changes
            activeSelect.addEventListener('change', function() {
                const selectedSerial = this.value;
                replacementSelect.innerHTML = '<option value="">Pilih Serial Number Pengganti</option>';
                
                allIJPs.filter(ijp => ijp.serialNumber !== selectedSerial).forEach(ijp => {
                    const option = document.createElement('option');
                    option.value = ijp.serialNumber;
                    option.textContent = `${ijp.serialNumber} - ${ijp.mesinUtama} - ${ijp.departemen}`;
                    replacementSelect.appendChild(option);
                });
            });
        }

        // Dashboard functions
        function updateDashboard() {
            updateScoreboard();
            updateChart();
            updateTypeChart();
            updateIJPList();
        }

        function updateScoreboard() {
            const totalIJP = ijpData.length;
            const totalAktif = ijpData.filter(ijp => ijp.status === 'AKTIF').length;
            const totalGantiFilter = ijpData.filter(ijp => ijp.cummulativeTime > 9500).length;
            const totalRusak = ijpData.filter(ijp => ijp.status === 'RUSAK').length;

            document.getElementById('totalIJP').textContent = totalIJP;
            document.getElementById('totalAktif').textContent = totalAktif;
            document.getElementById('totalGantiFilter').textContent = totalGantiFilter;
            document.getElementById('totalRusak').textContent = totalRusak;
        }

        function updateChart() {
            const ctx = document.getElementById('ijpChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Group data by department
            const departmentStats = {};
            const departments = ['Line 01A', 'Line 01B', 'Line 02', 'Line 03', 'Line 04', 'Line 05', 'Line 07'];
            
            departments.forEach(dept => {
                const deptIJPs = ijpData.filter(ijp => ijp.departemen === dept);
                departmentStats[dept] = {
                    total: deptIJPs.length,
                    aktif: deptIJPs.filter(ijp => ijp.status === 'AKTIF').length,
                    gantiFilter: deptIJPs.filter(ijp => ijp.cummulativeTime > 9500).length,
                    rusak: deptIJPs.filter(ijp => ijp.status === 'RUSAK').length
                };
            });
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: [
                        {
                            label: 'Total IJP',
                            data: departments.map(dept => departmentStats[dept].total),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'IJP Aktif',
                            data: departments.map(dept => departmentStats[dept].aktif),
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Harus Ganti Filter',
                            data: departments.map(dept => departmentStats[dept].gantiFilter),
                            backgroundColor: 'rgba(251, 191, 36, 0.8)',
                            borderColor: 'rgba(251, 191, 36, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'IJP Rusak',
                            data: departments.map(dept => departmentStats[dept].rusak),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Statistik IJP per Departemen'
                        }
                    }
                }
            });
        }

        function updateTypeChart() {
            const ctx = document.getElementById('ijpTypeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (typeChartInstance) {
                typeChartInstance.destroy();
            }
            
            // Group data by department and type
            const departments = ['Line 01A', 'Line 01B', 'Line 02', 'Line 03', 'Line 04', 'Line 05', 'Line 07'];
            const ijpTypes = ['PX', 'PXR', 'RX1', 'RX2', 'UX Single', 'UX Twin'];
            
            const typeStats = {};
            departments.forEach(dept => {
                typeStats[dept] = {};
                ijpTypes.forEach(type => {
                    typeStats[dept][type] = ijpData.filter(ijp => 
                        ijp.departemen === dept && ijp.tipeIJP === type
                    ).length;
                });
            });
            
            // Create datasets for each IJP type
            const datasets = ijpTypes.map((type, index) => {
                const colors = [
                    'rgba(59, 130, 246, 0.8)',   // Blue
                    'rgba(34, 197, 94, 0.8)',    // Green
                    'rgba(251, 191, 36, 0.8)',   // Yellow
                    'rgba(239, 68, 68, 0.8)',    // Red
                    'rgba(147, 51, 234, 0.8)',   // Purple
                    'rgba(236, 72, 153, 0.8)'    // Pink
                ];
                
                return {
                    label: type,
                    data: departments.map(dept => typeStats[dept][type]),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.8', '1'),
                    borderWidth: 1
                };
            });
            
            typeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: departments,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Tipe IJP per Departemen'
                        }
                    }
                }
            });
        }

        function updateIJPList() {
            const container = document.getElementById('ijpList');
            container.innerHTML = '';
            
            const departments = ['Line 01A', 'Line 01B', 'Line 02', 'Line 03', 'Line 04', 'Line 05', 'Line 07'];
            
            departments.forEach(dept => {
                const deptIJPs = ijpData.filter(ijp => ijp.departemen === dept);
                
                if (deptIJPs.length > 0) {
                    const deptDiv = document.createElement('div');
                    deptDiv.className = 'border border-gray-200 rounded-lg p-4';
                    
                    deptDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">${dept}</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mesin Utama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cummulative Time</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${deptIJPs.map(ijp => `
                                        <tr class="${ijp.cummulativeTime > 9500 ? 'blink bg-yellow-100' : ''}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ijp.serialNumber}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ijp.tipeIJP}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ijp.mesinUtama}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ijp.lokasi}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm ${ijp.cummulativeTime > 9500 ? 'text-red-600 font-bold' : 'text-gray-500'}">${ijp.cummulativeTime} hours</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ijp.status === 'RUSAK' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${ijp.status}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    container.appendChild(deptDiv);
                }
            });
        }

        // Refresh all data and UI
        async function refreshAllData() {
            await loadAllData();
            updateDashboard();
            updateMonitoringDropdown();
            updateRepairDropdown();
            updateSwitchingDropdowns();
        }

        // History functions
        async function loadHistoryData() {
            try {
                let allHistory = [];
                
                // Load IJP history
                const { data: ijps } = await supabase
                    .from('ijp_master')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (ijps) {
                    ijps.forEach(ijp => {
                        allHistory.push({
                            type: 'ijp',
                            timestamp: ijp.created_at,
                            pic: ijp.inisial_pic,
                            serial: ijp.serial_number,
                            description: `Input IJP baru: ${ijp.tipe_ijp} - ${ijp.mesin_utama} (${ijp.departemen})`,
                            details: `Lokasi: ${ijp.lokasi}, Status: ${ijp.status}`
                        });
                    });
                }
                
                // Load monitoring history
                const { data: monitoring } = await supabase
                    .from('monitoring_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (monitoring) {
                    monitoring.forEach(log => {
                        allHistory.push({
                            type: 'monitoring',
                            timestamp: log.created_at,
                            pic: log.inisial_pic,
                            serial: log.serial_number,
                            description: `Update monitoring: ${log.cummulative_time} jam total`,
                            details: `Cummulative time diupdate menjadi ${log.cummulative_time} jam`
                        });
                    });
                }
                
                // Load repair history
                const { data: repairs } = await supabase
                    .from('repair_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (repairs) {
                    repairs.forEach(repair => {
                        allHistory.push({
                            type: 'repair',
                            timestamp: repair.created_at,
                            pic: repair.inisial_pic,
                            serial: repair.serial_number,
                            description: `Repair: ${repair.kerusakan.substring(0, 50)}...`,
                            details: `Action: ${repair.action}${repair.ganti_filter_set ? ' | Filter Set diganti (Reset ke 0 jam)' : ''}`
                        });
                    });
                }
                
                // Load switching history
                const { data: switching } = await supabase
                    .from('switching_log')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (switching) {
                    switching.forEach(sw => {
                        allHistory.push({
                            type: 'switching',
                            timestamp: sw.created_at,
                            pic: sw.inisial_pic,
                            serial: sw.serial_diganti,
                            description: `Penukaran IJP: ${sw.serial_diganti}  ${sw.serial_pengganti}`,
                            details: `Alasan: ${sw.alasan_penggantian}`
                        });
                    });
                }
                
                // Sort by timestamp (newest first)
                allHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                return allHistory;
                
            } catch (error) {
                console.error('Error loading history:', error);
                return [];
            }
        }

        async function updateHistory() {
            const historyData = await loadHistoryData();
            const filter = document.getElementById('historyFilter').value;
            const container = document.getElementById('historyList');
            
            const filteredHistory = filter === 'all' ? historyData : historyData.filter(item => item.type === filter);
            
            if (filteredHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>';
                return;
            }
            
            container.innerHTML = filteredHistory.map(item => {
                const typeColors = {
                    ijp: 'bg-blue-100 text-blue-800',
                    monitoring: 'bg-green-100 text-green-800',
                    repair: 'bg-orange-100 text-orange-800',
                    switching: 'bg-purple-100 text-purple-800'
                };
                
                const typeLabels = {
                    ijp: 'INPUT IJP',
                    monitoring: 'MONITORING',
                    repair: 'REPAIR',
                    switching: 'SWITCHING'
                };
                
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${typeColors[item.type]}">
                                        ${typeLabels[item.type]}
                                    </span>
                                    <span class="text-sm text-gray-500">${formattedDate}</span>
                                </div>
                                <h4 class="text-sm font-medium text-gray-900 mb-1">${item.description}</h4>
                                <p class="text-sm text-gray-600 mb-2">${item.details}</p>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <span>PIC: ${item.pic}</span>
                                    <span>Serial: ${item.serial}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function refreshHistory() {
            await updateHistory();
            showNotification('History berhasil direfresh!', 'success');
        }

        // Form handlers with Supabase integration and auto-refresh
        document.getElementById('ijpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                const formData = new FormData(this);
                const newIJP = {
                    departemen: formData.get('departemen'),
                    inisialPIC: formData.get('inisialPIC').toUpperCase(),
                    tipeIJP: formData.get('tipeIJP'),
                    lokasi: formData.get('lokasi').toUpperCase(),
                    mesinUtama: formData.get('mesinUtama'),
                    serialNumber: formData.get('serialNumber').toUpperCase(),
                    cummulativeTime: 0,
                    status: 'AKTIF'
                };
                
                await saveIJP(newIJP);
                await refreshAllData(); // Auto refresh all data
                this.reset();
                
                showNotification('IJP berhasil ditambahkan!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Gagal menyimpan IJP: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan IJP';
            }
        });

        document.getElementById('monitoringForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                const formData = new FormData(this);
                const monitoringData = {
                    inisialPIC: formData.get('monitoringPIC').toUpperCase(),
                    serialNumber: formData.get('monitoringSerial'),
                    additionalTime: parseInt(formData.get('additionalTime'))
                };
                
                await saveMonitoring(monitoringData);
                await refreshAllData(); // Auto refresh all data
                this.reset();
                
                showNotification('Data monitoring berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Gagal menyimpan monitoring: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Monitoring';
            }
        });

        document.getElementById('repairForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                const formData = new FormData(this);
                const repairData = {
                    inisialPIC: formData.get('repairPIC').toUpperCase(),
                    serialNumber: formData.get('repairSerial'),
                    kerusakan: formData.get('kerusakan'),
                    action: formData.get('action'),
                    gantiFilterSet: !!formData.get('gantiFilterSet')
                };
                
                await saveRepair(repairData);
                await refreshAllData(); // Auto refresh all data
                this.reset();
                
                showNotification('Data repair berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Gagal menyimpan repair: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Repair';
            }
        });

        document.getElementById('switchingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                const formData = new FormData(this);
                const switchingData = {
                    inisialPIC: formData.get('switchingPIC').toUpperCase(),
                    serialDiganti: formData.get('serialDiganti'),
                    serialPengganti: formData.get('serialPengganti'),
                    alasanPenggantian: formData.get('alasanPenggantian')
                };
                
                await saveSwitching(switchingData);
                await refreshAllData(); // Auto refresh all data
                this.reset();
                
                showNotification('Data penukaran berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Gagal menyimpan penukaran: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan Penukaran';
            }
        });

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Database info function
        function showDatabaseInfo() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">Struktur Database Supabase</h3>
                    <div class="space-y-4 text-sm">
                        <div>
                            <h4 class="font-semibold text-blue-600">Tabel: ijp_master</h4>
                            <p class="text-gray-600">Kolom: id, departemen, inisial_pic, tipe_ijp, lokasi, mesin_utama, serial_number, cummulative_time, status, created_at</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-600">Tabel: monitoring_log</h4>
                            <p class="text-gray-600">Kolom: id, inisial_pic, serial_number, cummulative_time, created_at</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-600">Tabel: repair_log</h4>
                            <p class="text-gray-600">Kolom: id, inisial_pic, serial_number, kerusakan, action, ganti_filter_set, created_at</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-600">Tabel: switching_log</h4>
                            <p class="text-gray-600">Kolom: id, inisial_pic, serial_diganti, serial_pengganti, alasan_penggantian, created_at</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded">
                            <p class="text-yellow-800"><strong>Catatan:</strong> Pastikan tabel-tabel ini sudah dibuat di Supabase dengan struktur yang sesuai. Sistem akan menggunakan data sample jika koneksi database gagal.</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Tutup
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Clock function
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('id-ID', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
            
            const clockElement = document.getElementById('currentTime');
            if (clockElement) {
                clockElement.innerHTML = `${dateString}<br>${timeString}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            setupAutoUppercase();
            
            // Setup clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Setup history filter
            document.getElementById('historyFilter').addEventListener('change', updateHistory);
            
            // Show loading indicator
            showNotification('Memuat data dari Supabase...', 'info');
            
            try {
                await loadAllData();
                updateDashboard();
                showNotification('Data berhasil dimuat!', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Menggunakan data sample karena koneksi database gagal', 'error');
                updateDashboard();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'995955f6666ece32',t:'MTc2MTY0MzAwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
