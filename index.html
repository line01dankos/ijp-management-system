<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Management IJP - Versi Baru</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.error {
            background-color: #ef4444;
        }
        .high-hours {
            background-color: #fee2e2 !important;
            border-left: 4px solid #ef4444 !important;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }
        .broken-ijp {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
        }
        .uppercase-input {
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üîß Sistem Management IJP</h1>
            <p class="text-gray-600">Multi-Device & Real-time Sync</p>
            <div class="mt-4 flex justify-center items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-sm text-gray-600">Connected</span>
                </div>
                <div class="text-sm text-gray-500">
                    Total IJP: <span id="totalCount" class="font-semibold">0</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center mb-8">
            <div class="bg-white rounded-lg shadow-md p-1 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-1">
                <button id="tabInput" class="px-4 py-2 rounded-md font-medium transition-all bg-blue-500 text-white text-sm">
                    üìù Input IJP
                </button>
                <button id="tabMonitoring" class="px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm">
                    üìä Monitoring
                </button>
                <button id="tabDashboard" class="px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm">
                    üéØ Dashboard
                </button>
                <button id="tabSwitching" class="px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm">
                    üîÑ Switching
                </button>
                <button id="tabRepair" class="px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm">
                    üîß Repair
                </button>
                <button id="tabHistory" class="px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm">
                    üìã History
                </button>
            </div>
        </nav>

        <!-- Input IJP Section -->
        <main id="inputSection" class="max-w-2xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Input Data IJP Baru</h2>
                
                <form id="ijpForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="departemen" class="block text-sm font-medium text-gray-700 mb-2">Departemen</label>
                            <select id="departemen" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Departemen</option>
                                <option value="Line 01A">Line 01A</option>
                                <option value="Line 01B">Line 01B</option>
                                <option value="Line 02">Line 02</option>
                                <option value="Line 03">Line 03</option>
                                <option value="Line 04">Line 04</option>
                                <option value="Line 05">Line 05</option>
                                <option value="Line 07">Line 07</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="inisialPic" class="block text-sm font-medium text-gray-700 mb-2">Inisial PIC (Huruf Besar) - Contoh: ABC</label>
                            <input type="text" id="inisialPic" required minlength="3" maxlength="5" pattern="[A-Z]{3,5}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase-input">
                        </div>
                        
                        <div>
                            <label for="tipeIjp" class="block text-sm font-medium text-gray-700 mb-2">Tipe IJP</label>
                            <select id="tipeIjp" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Tipe</option>
                                <option value="PX">PX</option>
                                <option value="PXR">PXR</option>
                                <option value="RX1">RX1</option>
                                <option value="RX2">RX2</option>
                                <option value="UX Single">UX Single</option>
                                <option value="UX Twin">UX Twin</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="lokasi" class="block text-sm font-medium text-gray-700 mb-2">Lokasi N...</label>
                            <input type="text" id="lokasi" required placeholder="Contoh: N 2510"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="mesinUtama" class="block text-sm font-medium text-gray-700 mb-2">Mesin Utama</label>
                            <input type="text" id="mesinUtama" required placeholder="Contoh: Kunglong 5"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="serialNumber" class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
                            <input type="text" id="serialNumber" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <button type="submit" id="submitBtn" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <span id="submitText">üíæ Simpan Data IJP</span>
                        <div id="submitLoading" class="loading ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </main>

        <!-- Monitoring Section -->
        <section id="monitoringSection" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üìä Monitoring IJP</h2>
                
                <form id="monitoringForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="monitoringPic" class="block text-sm font-medium text-gray-700 mb-2">Inisial PIC (Huruf Besar) - Contoh: ABC</label>
                            <input type="text" id="monitoringPic" required minlength="3" maxlength="5" pattern="[A-Z]{3,5}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase-input">
                        </div>
                        
                        <div>
                            <label for="monitoringSerial" class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
                            <select id="monitoringSerial" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Serial Number</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="cumulativeTime" class="block text-sm font-medium text-gray-700 mb-2">Cumulative Op. Time (hours)</label>
                            <input type="number" id="cumulativeTime" required step="0.1" min="0"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <button type="submit" id="monitoringSubmitBtn" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <span id="monitoringSubmitText">üìä Update Cumulative Time</span>
                        <div id="monitoringSubmitLoading" class="loading ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üéØ Dashboard IJP</h2>
                    <div class="flex space-x-4">
                        <button id="refreshDashboard" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            üîÑ Refresh
                        </button>
                        <button id="downloadBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            üíæ Download Data
                        </button>
                    </div>
                </div>
                
                <div id="dashboardContainer" class="space-y-4">
                    <div class="flex justify-center py-8">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Switching Section -->
        <section id="switchingSection" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîÑ Switching Unit IJP</h2>
                
                <form id="switchingForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="switchingPic" class="block text-sm font-medium text-gray-700 mb-2">Inisial PIC (Huruf Besar) - Contoh: ABC</label>
                            <input type="text" id="switchingPic" required minlength="3" maxlength="5" pattern="[A-Z]{3,5}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase-input">
                        </div>
                        
                        <div>
                            <label for="switchingSerialAwal" class="block text-sm font-medium text-gray-700 mb-2">Serial Number IJP Awal</label>
                            <select id="switchingSerialAwal" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Serial Number Awal</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="switchingSerialPengganti" class="block text-sm font-medium text-gray-700 mb-2">Serial Number IJP Pengganti</label>
                            <select id="switchingSerialPengganti" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Serial Number Pengganti</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="switchingSpv" class="block text-sm font-medium text-gray-700 mb-2">Acc: Inisial SPV - Contoh: ABC</label>
                            <input type="text" id="switchingSpv" required minlength="3" maxlength="5" pattern="[A-Z]{3,5}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase-input">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="switchingAlasan" class="block text-sm font-medium text-gray-700 mb-2">Alasan Penggantian</label>
                            <textarea id="switchingAlasan" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" id="switchingSubmitBtn" 
                            class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <span id="switchingSubmitText">üîÑ Execute Switching</span>
                        <div id="switchingSubmitLoading" class="loading ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- Repair Section -->
        <section id="repairSection" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîß Repair IJP</h2>
                
                <form id="repairForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="repairPic" class="block text-sm font-medium text-gray-700 mb-2">Inisial PIC - Contoh: ABC</label>
                            <input type="text" id="repairPic" required minlength="3" maxlength="5" pattern="[A-Z]{3,5}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase-input">
                        </div>
                        
                        <div>
                            <label for="repairSerial" class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
                            <select id="repairSerial" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Pilih Serial Number</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="repairKerusakan" class="block text-sm font-medium text-gray-700 mb-2">Kerusakan (Jelaskan kerusakannya)</label>
                            <textarea id="repairKerusakan" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label for="repairAction" class="block text-sm font-medium text-gray-700 mb-2">Action (Jelaskan apa actionnya)</label>
                            <textarea id="repairAction" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="filterSetReplacement" class="mr-2">
                                <label for="filterSetReplacement" class="text-sm font-medium text-gray-700">
                                    Penggantian Filter Set (akan reset cumulative time ke 0)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" id="repairSubmitBtn" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <span id="repairSubmitText">üîß Submit Repair</span>
                        <div id="repairSubmitLoading" class="loading ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </section>

        <!-- History Section -->
        <section id="historySection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã History Aktivitas</h2>
                <div id="historyContainer">
                    <div class="flex justify-center py-8">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- IJP History Modal -->
    <div id="ijpHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="ijpHistoryTitle" class="text-lg font-bold">History IJP</h3>
                <button id="closeIjpHistory" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div id="ijpHistoryContent" class="space-y-3">
                <!-- History content will be populated -->
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Download Data IJP</h3>
            <form id="downloadForm">
                <div class="mb-4">
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                    <input type="date" id="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                    <input type="date" id="endDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">
                        üíæ Download
                    </button>
                    <button type="button" id="cancelDownload" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://yussyjcckcdlxeaihubs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1c3N5amNja2NkbHhlYWlodWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExODM4NjksImV4cCI6MjA3Njc1OTg2OX0.DzFeQSODk75k2Rp15bMagCT5V5b4WiujhbJG7HROcUY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentData = [];
        let currentHistory = [];

        // DOM Elements
        const sections = {
            input: document.getElementById('inputSection'),
            monitoring: document.getElementById('monitoringSection'),
            dashboard: document.getElementById('dashboardSection'),
            switching: document.getElementById('switchingSection'),
            repair: document.getElementById('repairSection'),
            history: document.getElementById('historySection')
        };

        const tabs = {
            input: document.getElementById('tabInput'),
            monitoring: document.getElementById('tabMonitoring'),
            dashboard: document.getElementById('tabDashboard'),
            switching: document.getElementById('tabSwitching'),
            repair: document.getElementById('tabRepair'),
            history: document.getElementById('tabHistory')
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadData();
            setupRealtimeSubscription();
        });

        // Event Listeners
        function setupEventListeners() {
            // Tab navigation
            Object.keys(tabs).forEach(key => {
                tabs[key].addEventListener('click', () => switchTab(key));
            });

            // Form submissions
            document.getElementById('ijpForm').addEventListener('submit', handleInputSubmit);
            document.getElementById('monitoringForm').addEventListener('submit', handleMonitoringSubmit);
            document.getElementById('switchingForm').addEventListener('submit', handleSwitchingSubmit);
            document.getElementById('repairForm').addEventListener('submit', handleRepairSubmit);

            // Switching serial number change
            document.getElementById('switchingSerialAwal').addEventListener('change', updateSwitchingOptions);

            // Download functionality
            document.getElementById('downloadBtn').addEventListener('click', openDownloadModal);
            document.getElementById('cancelDownload').addEventListener('click', closeDownloadModal);
            document.getElementById('downloadForm').addEventListener('submit', handleDownload);

            // IJP History modal
            document.getElementById('closeIjpHistory').addEventListener('click', closeIjpHistoryModal);

            // Refresh dashboard
            document.getElementById('refreshDashboard').addEventListener('click', loadDashboard);

            // Uppercase inputs
            document.querySelectorAll('.uppercase-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            });
        }

        // Tab switching
        function switchTab(tab) {
            // Reset all tabs
            Object.values(tabs).forEach(t => {
                t.className = 'px-4 py-2 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500 text-sm';
            });

            // Hide all sections
            Object.values(sections).forEach(s => {
                s.classList.add('hidden');
            });

            // Show selected tab and section
            tabs[tab].className = 'px-4 py-2 rounded-md font-medium transition-all bg-blue-500 text-white text-sm';
            sections[tab].classList.remove('hidden');

            // Load specific data based on tab
            switch(tab) {
                case 'monitoring':
                    loadMonitoringOptions();
                    break;
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'switching':
                    loadSwitchingOptions();
                    break;
                case 'repair':
                    loadRepairOptions();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // Input IJP Form
        async function handleInputSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            // Show loading
            submitBtn.disabled = true;
            submitText.textContent = 'Menyimpan...';
            submitLoading.classList.remove('hidden');

            try {
                const formData = {
                    departemen: document.getElementById('departemen').value,
                    inisial_pic: document.getElementById('inisialPic').value.toUpperCase(),
                    tipe_ijp: document.getElementById('tipeIjp').value,
                    lokasi: document.getElementById('lokasi').value,
                    mesin_utama: document.getElementById('mesinUtama').value,
                    serial_number: document.getElementById('serialNumber').value,
                    cumulative_time: 0,
                    status: 'aktif'
                };

                const { data, error } = await supabase
                    .from('ijp_data')
                    .insert([formData])
                    .select();

                if (error) throw error;

                // Add to history
                await addHistory('Input IJP', formData.inisial_pic, `IJP ${formData.serial_number} ditambahkan ke ${formData.lokasi} (${formData.mesin_utama})`);

                showToast('Data IJP berhasil disimpan!', 'success');
                document.getElementById('ijpForm').reset();
                loadData();

            } catch (error) {
                console.error('Error:', error);
                if (error.code === '23505') {
                    showToast('Serial number sudah ada!', 'error');
                } else {
                    showToast('Gagal menyimpan data: ' + error.message, 'error');
                }
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'üíæ Simpan Data IJP';
                submitLoading.classList.add('hidden');
            }
        }

        // Monitoring Functions
        function loadMonitoringOptions() {
            const serialSelect = document.getElementById('monitoringSerial');
            serialSelect.innerHTML = '<option value="">Pilih Serial Number</option>';
            
            currentData.forEach(item => {
                if (item.status === 'aktif') {
                    serialSelect.innerHTML += `<option value="${item.id}">${item.serial_number} - ${item.lokasi}</option>`;
                }
            });
        }

        async function handleMonitoringSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('monitoringSubmitBtn');
            const submitText = document.getElementById('monitoringSubmitText');
            const submitLoading = document.getElementById('monitoringSubmitLoading');
            
            // Show loading
            submitBtn.disabled = true;
            submitText.textContent = 'Updating...';
            submitLoading.classList.remove('hidden');

            try {
                const ijpId = document.getElementById('monitoringSerial').value;
                const pic = document.getElementById('monitoringPic').value.toUpperCase();
                const newTime = parseFloat(document.getElementById('cumulativeTime').value);

                // Get current data
                const currentIjp = currentData.find(item => item.id == ijpId);
                const updatedTime = (parseFloat(currentIjp.cumulative_time) || 0) + newTime;

                const { error } = await supabase
                    .from('ijp_data')
                    .update({
                        cumulative_time: updatedTime
                    })
                    .eq('id', ijpId);

                if (error) throw error;

                // Add to history
                await addHistory('Update Monitoring', pic, `IJP ${currentIjp.serial_number} cumulative time diupdate +${newTime} hours (Total: ${updatedTime} hours)`);

                showToast('Cumulative time berhasil diupdate!', 'success');
                document.getElementById('monitoringForm').reset();
                loadMonitoringOptions(); // Reload options after reset
                loadData();

            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal update monitoring: ' + error.message, 'error');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'üìä Update Cumulative Time';
                submitLoading.classList.add('hidden');
            }
        }

        // Dashboard Functions
        function loadDashboard() {
            renderDashboard(currentData);
        }

        function renderDashboard(data) {
            const container = document.getElementById('dashboardContainer');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">Belum ada data IJP</p>
                    </div>
                `;
                return;
            }

            const dashboardHtml = data.map(item => {
                const isHighHours = parseFloat(item.cumulative_time) > 9500;
                const isBroken = item.status === 'rusak';
                
                let cardClass = 'bg-white border rounded-lg p-4 shadow-sm';
                if (isBroken) {
                    cardClass += ' broken-ijp';
                } else if (isHighHours) {
                    cardClass += ' high-hours';
                }

                return `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-blue-600 cursor-pointer hover:text-blue-800 underline" onclick="showIjpHistory('${item.serial_number}')">${item.serial_number}</h3>
                                <p class="text-sm text-gray-600">üìç ${item.lokasi} - ${item.mesin_utama}</p>
                                <p class="text-sm text-gray-600">üè≠ ${item.departemen} | üîß ${item.tipe_ijp}</p>
                                <p class="text-sm text-gray-600">üë§ PIC: ${item.inisial_pic}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold ${isHighHours ? 'text-red-600' : 'text-blue-600'}">
                                    ${parseFloat(item.cumulative_time).toFixed(1)}h
                                </div>
                                <div class="text-xs ${isBroken ? 'text-yellow-600' : 'text-green-600'}">
                                    ${item.status.toUpperCase()}
                                </div>
                                ${isHighHours ? '<div class="text-xs text-red-600 font-bold">‚ö†Ô∏è >9500h</div>' : ''}
                                ${isBroken ? `<div class="text-xs text-yellow-600 mt-1">${item.alasan_rusak || 'Rusak'}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = dashboardHtml;
        }

        // Switching Functions
        function loadSwitchingOptions() {
            const serialAwalSelect = document.getElementById('switchingSerialAwal');
            serialAwalSelect.innerHTML = '<option value="">Pilih Serial Number Awal</option>';
            
            currentData.forEach(item => {
                serialAwalSelect.innerHTML += `<option value="${item.id}">${item.serial_number} - ${item.lokasi}</option>`;
            });
        }

        function updateSwitchingOptions() {
            const serialAwalId = document.getElementById('switchingSerialAwal').value;
            const serialPenggantiSelect = document.getElementById('switchingSerialPengganti');
            
            serialPenggantiSelect.innerHTML = '<option value="">Pilih Serial Number Pengganti</option>';
            
            currentData.forEach(item => {
                if (item.id != serialAwalId) {
                    serialPenggantiSelect.innerHTML += `<option value="${item.id}">${item.serial_number} - ${item.lokasi}</option>`;
                }
            });
        }

        async function handleSwitchingSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('switchingSubmitBtn');
            const submitText = document.getElementById('switchingSubmitText');
            const submitLoading = document.getElementById('switchingSubmitLoading');
            
            const alasan = document.getElementById('switchingAlasan').value.trim();
            
            // Validate reason
            const invalidReasons = ['N/A', 'NA', 'RUSAK', '-', '.', 'n/a', 'na', 'rusak'];
            if (invalidReasons.includes(alasan.toUpperCase()) || alasan.length < 10) {
                showToast('Jelaskan alasan penggantian secara detail!', 'error');
                return;
            }
            
            // Check for repetitive characters
            const hasRepetition = /(.)\1{4,}/.test(alasan);
            if (hasRepetition) {
                showToast('Jelaskan alasan penggantian secara detail!', 'error');
                return;
            }
            
            // Show loading
            submitBtn.disabled = true;
            submitText.textContent = 'Processing...';
            submitLoading.classList.remove('hidden');

            try {
                const pic = document.getElementById('switchingPic').value.toUpperCase();
                const serialAwalId = document.getElementById('switchingSerialAwal').value;
                const serialPenggantiId = document.getElementById('switchingSerialPengganti').value;
                const spv = document.getElementById('switchingSpv').value.toUpperCase();

                // Get IJP data
                const ijpAwal = currentData.find(item => item.id == serialAwalId);
                const ijpPengganti = currentData.find(item => item.id == serialPenggantiId);

                // Switch locations and machines - IJP pengganti mengambil tempat IJP awal
                const { error1 } = await supabase
                    .from('ijp_data')
                    .update({
                        lokasi: ijpAwal.lokasi,
                        mesin_utama: ijpAwal.mesin_utama
                    })
                    .eq('id', serialPenggantiId);

                // IJP awal menjadi rusak dan pindah ke lokasi IJP pengganti
                const { error2 } = await supabase
                    .from('ijp_data')
                    .update({
                        lokasi: ijpPengganti.lokasi,
                        mesin_utama: ijpPengganti.mesin_utama,
                        status: 'rusak',
                        alasan_rusak: alasan
                    })
                    .eq('id', serialAwalId);

                if (error1 || error2) throw error1 || error2;

                // Add to history
                await addHistory('Switching Unit', pic, `Switching: ${ijpAwal.serial_number} (rusak) ‚Üî ${ijpPengganti.serial_number} (menggantikan). Alasan: ${alasan}. Acc: ${spv}`);

                showToast('Switching berhasil dilakukan!', 'success');
                document.getElementById('switchingForm').reset();
                loadSwitchingOptions(); // Reload options after reset
                loadData();

            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal melakukan switching: ' + error.message, 'error');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'üîÑ Execute Switching';
                submitLoading.classList.add('hidden');
            }
        }

        // Repair Functions
        function loadRepairOptions() {
            const repairSelect = document.getElementById('repairSerial');
            repairSelect.innerHTML = '<option value="">Pilih Serial Number</option>';
            
            currentData.forEach(item => {
                const statusLabel = item.status === 'rusak' ? 'üî¥ RUSAK' : 'üü¢ AKTIF';
                repairSelect.innerHTML += `<option value="${item.id}">${item.serial_number} - ${statusLabel}</option>`;
            });
        }

        async function handleRepairSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('repairSubmitBtn');
            const submitText = document.getElementById('repairSubmitText');
            const submitLoading = document.getElementById('repairSubmitLoading');
            
            // Show loading
            submitBtn.disabled = true;
            submitText.textContent = 'Processing...';
            submitLoading.classList.remove('hidden');

            try {
                const pic = document.getElementById('repairPic').value.toUpperCase();
                const ijpId = document.getElementById('repairSerial').value;
                const kerusakan = document.getElementById('repairKerusakan').value;
                const action = document.getElementById('repairAction').value;
                const isFilterSetReplacement = document.getElementById('filterSetReplacement').checked;

                const ijp = currentData.find(item => item.id == ijpId);

                // Update IJP data
                const updateData = {
                    status: 'aktif' // Assume repair makes it active
                };

                if (isFilterSetReplacement) {
                    updateData.cumulative_time = 0;
                }

                const { error } = await supabase
                    .from('ijp_data')
                    .update(updateData)
                    .eq('id', ijpId);

                if (error) throw error;

                // Add to history
                const historyDetail = `Repair IJP ${ijp.serial_number}. Kerusakan: ${kerusakan}. Action: ${action}${isFilterSetReplacement ? '. Filter Set diganti - Cumulative time direset ke 0' : ''}`;
                await addHistory('Repair', pic, historyDetail);

                showToast('Repair berhasil disubmit!', 'success');
                document.getElementById('repairForm').reset();
                loadRepairOptions(); // Reload options after reset
                loadData();

            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal submit repair: ' + error.message, 'error');
            } finally {
                // Reset button
                submitBtn.disabled = false;
                submitText.textContent = 'üîß Submit Repair';
                submitLoading.classList.add('hidden');
            }
        }

        // Load data from Supabase
        async function loadData() {
            try {
                document.getElementById('connectionStatus').className = 'w-3 h-3 bg-green-500 rounded-full';
                
                const { data, error } = await supabase
                    .from('ijp_data')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                currentData = data || [];
                document.getElementById('totalCount').textContent = currentData.length;
                
                // Update current tab if needed
                const currentTab = Object.keys(sections).find(key => !sections[key].classList.contains('hidden'));
                if (currentTab === 'dashboard') {
                    loadDashboard();
                } else if (currentTab === 'monitoring') {
                    loadMonitoringOptions();
                } else if (currentTab === 'switching') {
                    loadSwitchingOptions();
                } else if (currentTab === 'repair') {
                    loadRepairOptions();
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('connectionStatus').className = 'w-3 h-3 bg-red-500 rounded-full';
                showToast('Gagal memuat data: ' + error.message, 'error');
            }
        }

        // History functions
        async function loadHistory() {
            try {
                const { data, error } = await supabase
                    .from('history_data')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                currentHistory = data || [];
                renderHistory(currentHistory);

            } catch (error) {
                console.error('Error loading history:', error);
                showToast('Gagal memuat history: ' + error.message, 'error');
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">Belum ada history aktivitas</p>
                    </div>
                `;
                return;
            }

            const historyHtml = history.map(item => `
                <div class="border-l-4 border-blue-500 pl-4 py-3 mb-4 bg-gray-50 rounded-r-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${item.activity}</h4>
                            <p class="text-gray-600 text-sm">${item.detail}</p>
                            <p class="text-gray-500 text-xs mt-1">oleh: ${item.pic}</p>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(item.created_at).toLocaleString('id-ID')}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = historyHtml;
        }

        async function addHistory(activity, pic, detail) {
            try {
                const { error } = await supabase
                    .from('history_data')
                    .insert([{
                        activity: activity,
                        pic: pic,
                        detail: detail
                    }]);

                if (error) throw error;
            } catch (error) {
                console.error('Error adding history:', error);
            }
        }

        // Download functions
        function openDownloadModal() {
            document.getElementById('downloadModal').classList.remove('hidden');
            document.getElementById('downloadModal').classList.add('flex');
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.add('hidden');
            document.getElementById('downloadModal').classList.remove('flex');
        }

        async function handleDownload(e) {
            e.preventDefault();

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            try {
                const { data, error } = await supabase
                    .from('ijp_data')
                    .select('*')
                    .gte('created_at', startDate + 'T00:00:00')
                    .lte('created_at', endDate + 'T23:59:59')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    showToast('Tidak ada data pada rentang tanggal tersebut!', 'error');
                    return;
                }

                downloadCSV(data, `IJP_Data_${startDate}_to_${endDate}.csv`);
                showToast(`Data berhasil didownload (${data.length} records)!`, 'success');
                closeDownloadModal();

            } catch (error) {
                console.error('Error downloading data:', error);
                showToast('Gagal download data: ' + error.message, 'error');
            }
        }

        function downloadCSV(data, filename) {
            const headers = ['Serial Number', 'Departemen', 'PIC', 'Tipe IJP', 'Lokasi', 'Mesin Utama', 'Cumulative Time', 'Status', 'Alasan Rusak', 'Tanggal Dibuat'];
            
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    item.serial_number,
                    item.departemen,
                    item.inisial_pic,
                    item.tipe_ijp,
                    item.lokasi,
                    item.mesin_utama,
                    item.cumulative_time,
                    item.status,
                    item.alasan_rusak || '',
                    new Date(item.created_at).toLocaleString('id-ID')
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Real-time subscription
        function setupRealtimeSubscription() {
            // Subscribe to IJP data changes
            supabase
                .channel('ijp_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'ijp_data' }, 
                    (payload) => {
                        console.log('Real-time update:', payload);
                        loadData();
                    }
                )
                .subscribe();

            // Subscribe to history changes
            supabase
                .channel('history_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'history_data' }, 
                    (payload) => {
                        if (!sections.history.classList.contains('hidden')) {
                            loadHistory();
                        }
                    }
                )
                .subscribe();
        }

        // IJP History Modal Functions
        async function showIjpHistory(serialNumber) {
            try {
                const { data, error } = await supabase
                    .from('history_data')
                    .select('*')
                    .ilike('detail', `%${serialNumber}%`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                document.getElementById('ijpHistoryTitle').textContent = `History IJP ${serialNumber}`;
                
                const historyHtml = data.length > 0 ? data.map(item => `
                    <div class="border-l-4 border-blue-500 pl-3 py-2 bg-gray-50 rounded-r">
                        <p class="font-semibold text-sm">${item.activity}</p>
                        <p class="text-xs text-gray-600">${item.detail}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date(item.created_at).toLocaleString('id-ID')} - ${item.pic}</p>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">Belum ada history untuk IJP ini</p>';

                document.getElementById('ijpHistoryContent').innerHTML = historyHtml;
                document.getElementById('ijpHistoryModal').classList.remove('hidden');
                document.getElementById('ijpHistoryModal').classList.add('flex');

            } catch (error) {
                console.error('Error loading IJP history:', error);
                showToast('Gagal memuat history IJP: ' + error.message, 'error');
            }
        }

        function closeIjpHistoryModal() {
            document.getElementById('ijpHistoryModal').classList.add('hidden');
            document.getElementById('ijpHistoryModal').classList.remove('flex');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9935bf0867425f6a',t:'MTc2MTI2OTgxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
