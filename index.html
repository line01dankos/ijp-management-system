<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checklist Harian Anak</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      width: 100%;
    }

    .app-container {
      width: 100%;
      min-height: 100%;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
    }

    .sync-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      margin-top: 10px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      padding: 0 20px;
      gap: 10px;
    }

    .tab {
      padding: 15px 25px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 16px;
      font-weight: 500;
      color: #6c757d;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .content {
      padding: 30px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .score-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .score-card {
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
    }

    .score-card.positive {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .score-card.negative {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }

    .score-card.games {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .score-value {
      font-size: 36px;
      font-weight: 700;
      margin: 10px 0;
    }

    .score-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .chart-container {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 14px;
      font-weight: 500;
      color: #495057;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .checklist-section {
      margin-top: 30px;
    }

    .checklist-section h3 {
      color: #495057;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checklist-items {
      display: grid;
      gap: 10px;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .checklist-item:hover {
      background: #e9ecef;
    }

    .checklist-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checklist-item label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      font-weight: 400;
    }

    .checklist-item .menit {
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
    }

    .checklist-item.positive .menit {
      background: #38ef7d;
      color: white;
    }

    .checklist-item.negative .menit {
      background: #f45c43;
      color: white;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
      padding: 8px 15px;
      font-size: 14px;
    }

    .btn-success:hover,
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .login-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-container h2 {
      color: #495057;
      margin-bottom: 30px;
    }

    .kelola-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .kelola-section h3 {
      color: #495057;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .kegiatan-list {
      display: grid;
      gap: 10px;
      margin-top: 20px;
    }

    .kegiatan-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid;
    }

    .kegiatan-item.positive {
      border-left-color: #38ef7d;
    }

    .kegiatan-item.negative {
      border-left-color: #f45c43;
    }

    .kegiatan-info {
      flex: 1;
    }

    .kegiatan-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .kegiatan-menit {
      font-size: 14px;
      color: #6c757d;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    .toast.success {
      border-left: 4px solid #38ef7d;
    }

    .toast.error {
      border-left: 4px solid #f45c43;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 22px;
      }

      .tabs {
        overflow-x: auto;
        padding: 0 10px;
      }

      .tab {
        padding: 12px 20px;
        font-size: 14px;
      }

      .content {
        padding: 20px 15px;
      }

      .score-cards {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container">
   <div class="header">
    <h1 id="app-title">Checklist Harian Anak</h1>
   </div>
   <div class="tabs"><button class="tab active" data-tab="dashboard">üìä Dashboard</button> <button class="tab" data-tab="input">‚úèÔ∏è Input</button> <button class="tab" data-tab="kelola">‚öôÔ∏è Kelola Kegiatan</button>
   </div>
   <div class="content"><!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard">
     <div class="filters">
      <div class="filter-group"><label for="filter-start">Tanggal Mulai</label> <input type="date" id="filter-start">
      </div>
      <div class="filter-group"><label for="filter-end">Tanggal Akhir</label> <input type="date" id="filter-end">
      </div>
      <div class="filter-group"><label for="filter-jenis">Jenis Kegiatan</label> <select id="filter-jenis"> <option value="all">Semua</option> <option value="positif">Positif</option> <option value="negatif">Negatif</option> </select>
      </div>
     </div>
     <div class="score-cards">
      <div class="score-card positive">
       <div class="score-label">
        Total Waktu Positif
       </div>
       <div class="score-value" id="total-positif">
        0
       </div>
       <div class="score-label">
        menit
       </div>
      </div>
      <div class="score-card negative">
       <div class="score-label">
        Total Waktu Negatif
       </div>
       <div class="score-value" id="total-negatif">
        0
       </div>
       <div class="score-label">
        menit
       </div>
      </div>
      <div class="score-card games">
       <div class="score-label">
        Waktu Main Games
       </div>
       <div class="score-value" id="waktu-games">
        240
       </div>
       <div class="score-label">
        menit
       </div>
      </div>
     </div>
     <div class="chart-container">
      <h3 id="dashboard-title" style="color: #495057; margin-bottom: 20px;">Grafik Kegiatan Harian</h3>
      <canvas id="activityChart"></canvas>
     </div>
     <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
      <div class="chart-container">
       <h3 style="color: #495057; margin-bottom: 20px;">üìà Detail Kegiatan Positif</h3>
       <canvas id="positifChart"></canvas>
      </div>
      <div class="chart-container">
       <h3 style="color: #495057; margin-bottom: 20px;">üìâ Detail Kegiatan Negatif</h3>
       <canvas id="negatifChart"></canvas>
      </div>
     </div>
    </div><!-- Input Tab -->
    <div class="tab-content" id="input">
     <div class="form-container">
      <h2 id="input-title" style="color: #495057; margin-bottom: 30px;">Input Kegiatan Harian</h2>
      <form id="input-form">
       <div class="form-group"><label for="input-tanggal">Tanggal</label> <input type="date" id="input-tanggal" required>
       </div>
       <div class="checklist-section">
        <h3>‚úÖ Kegiatan Positif</h3>
        <div class="checklist-items" id="checklist-positif"></div>
       </div>
       <div class="checklist-section">
        <h3>‚ùå Kegiatan Negatif</h3>
        <div class="checklist-items" id="checklist-negatif"></div>
       </div>
       <div style="text-align: center; margin-top: 30px;"><button type="submit" class="btn btn-primary">Simpan Kegiatan</button>
       </div>
      </form>
     </div>
    </div><!-- Kelola Tab -->
    <div class="tab-content" id="kelola">
     <div id="login-screen" class="login-container">
      <h2>üîê Login Admin</h2>
      <form id="login-form">
       <div class="form-group"><label for="password">Password</label> <input type="password" id="password" required placeholder="Masukkan password">
       </div><button type="submit" class="btn btn-primary">Login</button>
      </form>
     </div>
     <div id="kelola-content" style="display: none;">
      <div class="kelola-section">
       <h3>‚úÖ Tambah Kegiatan Positif</h3>
       <form id="form-positif">
        <div style="display: grid; grid-template-columns: 1fr 150px auto; gap: 15px; align-items: end;">
         <div class="form-group" style="margin: 0;"><label for="nama-positif">Nama Kegiatan</label> <input type="text" id="nama-positif" placeholder="Contoh: Belajar" required>
         </div>
         <div class="form-group" style="margin: 0;"><label for="menit-positif">Reward (menit)</label> <input type="number" id="menit-positif" min="1" placeholder="30" required>
         </div><button type="submit" class="btn btn-success">Tambah</button>
        </div>
       </form>
       <div class="kegiatan-list" id="list-positif"></div>
      </div>
      <div class="kelola-section">
       <h3>‚ùå Tambah Kegiatan Negatif</h3>
       <form id="form-negatif">
        <div style="display: grid; grid-template-columns: 1fr 150px auto; gap: 15px; align-items: end;">
         <div class="form-group" style="margin: 0;"><label for="nama-negatif">Nama Kegiatan</label> <input type="text" id="nama-negatif" placeholder="Contoh: Marah-marah" required>
         </div>
         <div class="form-group" style="margin: 0;"><label for="menit-negatif">Sanksi (menit)</label> <input type="number" id="menit-negatif" min="1" placeholder="15" required>
         </div><button type="submit" class="btn btn-success">Tambah</button>
        </div>
       </form>
       <div class="kegiatan-list" id="list-negatif"></div>
      </div>
     </div>
    </div>
   </div>
   <div id="toast" class="toast"></div>
   <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Menyimpan data...</p>
   </div><!-- Modal Edit -->
   <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
     <h3 style="margin-bottom: 20px; color: #495057;">Edit Kegiatan</h3>
     <form id="edit-form">
      <div class="form-group"><label for="edit-nama">Nama Kegiatan</label> <input type="text" id="edit-nama" required>
      </div>
      <div class="form-group"><label for="edit-menit">Menit</label> <input type="number" id="edit-menit" min="1" required>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;"><button type="button" class="btn btn-danger" onclick="closeEditModal()">Batal</button> <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
     </form>
    </div>
   </div><!-- Modal Password -->
   <div id="password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">
     <h3 style="margin-bottom: 20px; color: #495057;">üîê Verifikasi Ayah</h3>
     <form id="password-form">
      <div class="form-group"><label for="verify-password">Masukkan Password Ayah</label> <input type="password" id="verify-password" required placeholder="Password">
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;"><button type="button" class="btn btn-danger" onclick="closePasswordModal()">Batal</button> <button type="submit" class="btn btn-primary">Verifikasi</button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Checklist Harian Anak",
      dashboard_title: "Grafik Kegiatan Harian",
      input_title: "Input Kegiatan Harian",
      kelola_title: "Kelola Kegiatan",
      webhook_url: "https://gaybffstouojtacnvvyj.supabase.co/rest/v1/kegiatan_anak",
      anon_key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdheWJmZnN0b3VvanRhY252dnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTk4OTcsImV4cCI6MjA4MDM5NTg5N30.KR2Jet-HfCI5UmqUODSrWyJAjr0Tveu9XHRPsEubr2g",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      positive_color: "#38ef7d",
      negative_color: "#f45c43",
      games_color: "#f5576c"
    };

    let activityChart = null;
    let positifChart = null;
    let negatifChart = null;
    let isLoggedIn = false;
    let allRecords = [];
    let idleTimer = null;

    const dataHandler = {
      onDataChanged(data) {
        allRecords = data;
        updateDashboard();
        updateChecklistForms();
        updateKelolaLists();
      }
    };

    async function onConfigChange(config) {
      const appTitle = config.app_title || defaultConfig.app_title;
      const dashboardTitle = config.dashboard_title || defaultConfig.dashboard_title;
      const inputTitle = config.input_title || defaultConfig.input_title;

      document.getElementById('app-title').textContent = appTitle;
      document.getElementById('dashboard-title').textContent = dashboardTitle;
      document.getElementById('input-title').textContent = inputTitle;

      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const positiveColor = config.positive_color || defaultConfig.positive_color;
      const negativeColor = config.negative_color || defaultConfig.negative_color;
      const gamesColor = config.games_color || defaultConfig.games_color;

      document.querySelector('.header').style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
      
      const positiveCards = document.querySelectorAll('.score-card.positive');
      positiveCards.forEach(card => {
        card.style.background = `linear-gradient(135deg, #11998e 0%, ${positiveColor} 100%)`;
      });

      const negativeCards = document.querySelectorAll('.score-card.negative');
      negativeCards.forEach(card => {
        card.style.background = `linear-gradient(135deg, #eb3349 0%, ${negativeColor} 100%)`;
      });

      const gamesCards = document.querySelectorAll('.score-card.games');
      gamesCards.forEach(card => {
        card.style.background = `linear-gradient(135deg, #f093fb 0%, ${gamesColor} 100%)`;
      });

      const allButtons = document.querySelectorAll('.btn-primary');
      allButtons.forEach(btn => {
        btn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
      });
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => config.secondary_color || defaultConfig.secondary_color,
            set: (value) => {
              config.secondary_color = value;
              window.elementSdk.setConfig({ secondary_color: value });
            }
          },
          {
            get: () => config.positive_color || defaultConfig.positive_color,
            set: (value) => {
              config.positive_color = value;
              window.elementSdk.setConfig({ positive_color: value });
            }
          },
          {
            get: () => config.negative_color || defaultConfig.negative_color,
            set: (value) => {
              config.negative_color = value;
              window.elementSdk.setConfig({ negative_color: value });
            }
          },
          {
            get: () => config.games_color || defaultConfig.games_color,
            set: (value) => {
              config.games_color = value;
              window.elementSdk.setConfig({ games_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["dashboard_title", config.dashboard_title || defaultConfig.dashboard_title],
        ["input_title", config.input_title || defaultConfig.input_title],
        ["kelola_title", config.kelola_title || defaultConfig.kelola_title],
        ["webhook_url", config.webhook_url || defaultConfig.webhook_url],
        ["anon_key", config.anon_key || defaultConfig.anon_key]
      ]);
    }

    async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }

      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          showToast('Gagal menginisialisasi sistem', 'error');
        }
      }

      setupTabs();
      setupFilters();
      setupForms();
      setDefaultDate();
      initChart();
      initDetailCharts();
    }

    function resetIdleTimer() {
      if (idleTimer) {
        clearTimeout(idleTimer);
      }
      
      if (isLoggedIn) {
        idleTimer = setTimeout(() => {
          isLoggedIn = false;
          document.getElementById('login-screen').style.display = 'block';
          document.getElementById('kelola-content').style.display = 'none';
          showToast('Sesi berakhir karena tidak ada aktivitas.', 'error');
        }, 15000);
      }
    }

    function stopIdleTimer() {
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;

          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));

          tab.classList.add('active');
          document.getElementById(targetTab).classList.add('active');

          if (targetTab === 'dashboard') {
            updateDashboard();
          }

          if (targetTab !== 'kelola') {
            stopIdleTimer();
          } else if (isLoggedIn) {
            resetIdleTimer();
          }
        });
      });
    }

    function setDefaultDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('input-tanggal').value = today;
      document.getElementById('filter-start').value = today;
      document.getElementById('filter-end').value = today;
    }

    function setupFilters() {
      document.getElementById('filter-start').addEventListener('change', updateDashboard);
      document.getElementById('filter-end').addEventListener('change', updateDashboard);
      document.getElementById('filter-jenis').addEventListener('change', updateDashboard);
    }

    function setupForms() {
      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        if (password === 'cimenG90') {
          isLoggedIn = true;
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('kelola-content').style.display = 'block';
          document.getElementById('password').value = '';
          showToast('Login berhasil! Auto-lock jika tidak ada aktivitas 15 detik.', 'success');
          
          resetIdleTimer();

          const kelolaContent = document.getElementById('kelola-content');
          kelolaContent.addEventListener('click', resetIdleTimer);
          kelolaContent.addEventListener('keypress', resetIdleTimer);
          kelolaContent.addEventListener('input', resetIdleTimer);
        } else {
          showToast('Password salah!', 'error');
        }
      });

      document.getElementById('input-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveChecklist();
      });

      document.getElementById('form-positif').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addKegiatan('positif');
      });

      document.getElementById('form-negatif').addEventListener('submit', async (e) => {
        e.preventDefault();
        await addKegiatan('negatif');
      });

      document.getElementById('nama-positif').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });

      document.getElementById('nama-negatif').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });

      document.getElementById('edit-nama').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
    }

    async function saveChecklist() {
      const tanggal = document.getElementById('input-tanggal').value;
      const checkboxes = document.querySelectorAll('#input-form input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
        showToast('Pilih minimal satu kegiatan', 'error');
        return;
      }

      if (allRecords.length >= 999) {
        showToast('Batas maksimal 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
        return;
      }

      const parentPassword = await showPasswordPrompt();
      if (parentPassword !== 'cimenG90') {
        showToast('Password salah! Hanya Ayah yang bisa menyimpan.', 'error');
        return;
      }

      showLoading(true);

      for (const checkbox of checkboxes) {
        const kegiatanId = checkbox.value;
        const jenis = checkbox.dataset.jenis;
        const nama = checkbox.dataset.nama;
        const menit = parseInt(checkbox.dataset.menit);

        const record = {
          id: `${tanggal}-${kegiatanId}-${Date.now()}`,
          tanggal: tanggal,
          kegiatan_id: kegiatanId,
          jenis: jenis,
          nama_kegiatan: nama,
          menit: menit,
          completed: true
        };

        const result = await window.dataSdk.create(record);
        if (!result.isOk) {
          showLoading(false);
          showToast('Gagal menyimpan data', 'error');
          return;
        }
      }

      showLoading(false);
      showToast('Data berhasil disimpan!', 'success');
      document.getElementById('input-form').reset();
      setDefaultDate();
    }

    async function addKegiatan(jenis) {
      if (allRecords.length >= 999) {
        showToast('Batas maksimal 999 data tercapai', 'error');
        return;
      }

      const namaInput = document.getElementById(`nama-${jenis}`);
      const menitInput = document.getElementById(`menit-${jenis}`);
      const nama = namaInput.value;
      const menit = parseInt(menitInput.value);

      showLoading(true);

      const record = {
        id: `kegiatan-${jenis}-${Date.now()}`,
        tanggal: 'template',
        kegiatan_id: `${jenis}-${Date.now()}`,
        jenis: jenis,
        nama_kegiatan: nama,
        menit: menit,
        completed: false
      };

      const result = await window.dataSdk.create(record);
      
      showLoading(false);

      if (result.isOk) {
        showToast('Kegiatan berhasil ditambahkan!', 'success');
        namaInput.value = '';
        menitInput.value = '';
      } else {
        showToast('Gagal menambahkan kegiatan', 'error');
      }
    }

    async function deleteKegiatan(record) {
      showLoading(true);
      const result = await window.dataSdk.delete(record);
      showLoading(false);

      if (result.isOk) {
        showToast('Kegiatan berhasil dihapus!', 'success');
      } else {
        showToast('Gagal menghapus kegiatan', 'error');
      }
    }

    function updateChecklistForms() {
      const templates = allRecords.filter(r => r.tanggal === 'template');
      const positif = templates.filter(r => r.jenis === 'positif');
      const negatif = templates.filter(r => r.jenis === 'negatif');

      const positifContainer = document.getElementById('checklist-positif');
      const negatifContainer = document.getElementById('checklist-negatif');

      positifContainer.innerHTML = positif.map(k => `
        <div class="checklist-item positive">
          <input type="checkbox" id="check-${k.id}" value="${k.kegiatan_id}" data-jenis="${k.jenis}" data-nama="${k.nama_kegiatan}" data-menit="${k.menit}">
          <label for="check-${k.id}">${k.nama_kegiatan}</label>
          <span class="menit">+${k.menit} menit</span>
        </div>
      `).join('');

      negatifContainer.innerHTML = negatif.map(k => `
        <div class="checklist-item negative">
          <input type="checkbox" id="check-${k.id}" value="${k.kegiatan_id}" data-jenis="${k.jenis}" data-nama="${k.nama_kegiatan}" data-menit="${k.menit}">
          <label for="check-${k.id}">${k.nama_kegiatan}</label>
          <span class="menit">-${k.menit} menit</span>
        </div>
      `).join('');
    }

    function updateKelolaLists() {
      const templates = allRecords.filter(r => r.tanggal === 'template');
      const positif = templates.filter(r => r.jenis === 'positif');
      const negatif = templates.filter(r => r.jenis === 'negatif');

      const positifList = document.getElementById('list-positif');
      const negatifList = document.getElementById('list-negatif');

      positifList.innerHTML = positif.map(k => `
        <div class="kegiatan-item positive">
          <div class="kegiatan-info">
            <div class="kegiatan-name">${k.nama_kegiatan}</div>
            <div class="kegiatan-menit">Reward: +${k.menit} menit</div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="editKegiatanById('${k.__backendId}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteKegiatanById('${k.__backendId}')">Hapus</button>
          </div>
        </div>
      `).join('');

      negatifList.innerHTML = negatif.map(k => `
        <div class="kegiatan-item negative">
          <div class="kegiatan-info">
            <div class="kegiatan-name">${k.nama_kegiatan}</div>
            <div class="kegiatan-menit">Sanksi: -${k.menit} menit</div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="editKegiatanById('${k.__backendId}')">Edit</button>
            <button class="btn btn-danger" onclick="deleteKegiatanById('${k.__backendId}')">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    let currentEditRecord = null;
    let passwordResolve = null;

    window.deleteKegiatanById = function(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (record) {
        deleteKegiatan(record);
      }
    };

    window.editKegiatanById = function(backendId) {
      const record = allRecords.find(r => r.__backendId === backendId);
      if (record) {
        currentEditRecord = record;
        document.getElementById('edit-nama').value = record.nama_kegiatan;
        document.getElementById('edit-menit').value = record.menit;
        document.getElementById('edit-modal').style.display = 'flex';
      }
    };

    window.closeEditModal = function() {
      document.getElementById('edit-modal').style.display = 'none';
      currentEditRecord = null;
    };

    window.closePasswordModal = function() {
      document.getElementById('password-modal').style.display = 'none';
      if (passwordResolve) {
        passwordResolve(null);
        passwordResolve = null;
      }
    };

    function showPasswordPrompt() {
      return new Promise((resolve) => {
        passwordResolve = resolve;
        document.getElementById('verify-password').value = '';
        document.getElementById('password-modal').style.display = 'flex';
        
        document.getElementById('password-form').onsubmit = (e) => {
          e.preventDefault();
          const password = document.getElementById('verify-password').value;
          document.getElementById('password-modal').style.display = 'none';
          resolve(password);
          passwordResolve = null;
        };
      });
    }

    document.getElementById('edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentEditRecord) return;

      const namaUpdate = document.getElementById('edit-nama').value;
      const menitUpdate = parseInt(document.getElementById('edit-menit').value);

      showLoading(true);

      const updatedRecord = {
        ...currentEditRecord,
        nama_kegiatan: namaUpdate,
        menit: menitUpdate
      };

      const result = await window.dataSdk.update(updatedRecord);
      
      showLoading(false);

      if (result.isOk) {
        showToast('Kegiatan berhasil diupdate!', 'success');
        closeEditModal();
      } else {
        showToast('Gagal mengupdate kegiatan', 'error');
      }
    });

    function updateDashboard() {
      const startDate = document.getElementById('filter-start').value;
      const endDate = document.getElementById('filter-end').value;
      const jenisFilter = document.getElementById('filter-jenis').value;

      let filtered = allRecords.filter(r => r.tanggal !== 'template' && r.completed);

      if (startDate) {
        filtered = filtered.filter(r => r.tanggal >= startDate);
      }
      if (endDate) {
        filtered = filtered.filter(r => r.tanggal <= endDate);
      }
      if (jenisFilter !== 'all') {
        filtered = filtered.filter(r => r.jenis === jenisFilter);
      }

      const totalPositif = filtered
        .filter(r => r.jenis === 'positif')
        .reduce((sum, r) => sum + r.menit, 0);

      const totalNegatif = filtered
        .filter(r => r.jenis === 'negatif')
        .reduce((sum, r) => sum + r.menit, 0);

      const waktuGames = 240 + totalPositif - totalNegatif;

      document.getElementById('total-positif').textContent = totalPositif;
      document.getElementById('total-negatif').textContent = totalNegatif;
      document.getElementById('waktu-games').textContent = Math.max(0, waktuGames);

      updateChart(filtered);
      updateDetailCharts(filtered);
    }

    function initChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      activityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Kegiatan Positif (menit)',
              data: [],
              backgroundColor: '#38ef7d'
            },
            {
              label: 'Kegiatan Negatif (menit)',
              data: [],
              backgroundColor: '#f45c43'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function initDetailCharts() {
      const ctxPositif = document.getElementById('positifChart').getContext('2d');
      positifChart = new Chart(ctxPositif, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Menit',
            data: [],
            backgroundColor: '#38ef7d'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      const ctxNegatif = document.getElementById('negatifChart').getContext('2d');
      negatifChart = new Chart(ctxNegatif, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Menit',
            data: [],
            backgroundColor: '#f45c43'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function updateChart(filtered) {
      const groupedByDate = {};

      filtered.forEach(r => {
        if (!groupedByDate[r.tanggal]) {
          groupedByDate[r.tanggal] = { positif: 0, negatif: 0 };
        }
        if (r.jenis === 'positif') {
          groupedByDate[r.tanggal].positif += r.menit;
        } else {
          groupedByDate[r.tanggal].negatif += r.menit;
        }
      });

      const dates = Object.keys(groupedByDate).sort();
      const positifData = dates.map(d => groupedByDate[d].positif);
      const negatifData = dates.map(d => groupedByDate[d].negatif);

      activityChart.data.labels = dates;
      activityChart.data.datasets[0].data = positifData;
      activityChart.data.datasets[1].data = negatifData;
      activityChart.update();
    }

    function updateDetailCharts(filtered) {
      const positifRecords = filtered.filter(r => r.jenis === 'positif');
      const negatifRecords = filtered.filter(r => r.jenis === 'negatif');

      const positifByKegiatan = {};
      positifRecords.forEach(r => {
        if (!positifByKegiatan[r.nama_kegiatan]) {
          positifByKegiatan[r.nama_kegiatan] = 0;
        }
        positifByKegiatan[r.nama_kegiatan] += r.menit;
      });

      const negatifByKegiatan = {};
      negatifRecords.forEach(r => {
        if (!negatifByKegiatan[r.nama_kegiatan]) {
          negatifByKegiatan[r.nama_kegiatan] = 0;
        }
        negatifByKegiatan[r.nama_kegiatan] += r.menit;
      });

      const positifLabels = Object.keys(positifByKegiatan);
      const positifData = Object.values(positifByKegiatan);

      const negatifLabels = Object.keys(negatifByKegiatan);
      const negatifData = Object.values(negatifByKegiatan);

      positifChart.data.labels = positifLabels;
      positifChart.data.datasets[0].data = positifData;
      positifChart.update();

      negatifChart.data.labels = negatifLabels;
      negatifChart.data.datasets[0].data = negatifData;
      negatifChart.update();
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.add('show');
      } else {
        loading.classList.remove('show');
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a8957344402577a',t:'MTc2NDgzMDcyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
